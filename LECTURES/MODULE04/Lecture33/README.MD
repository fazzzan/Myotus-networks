# OTUS 20210622

# VPN #

![](pictures/01.jpg)

![](pictures/02.jpg)

провайдерский VPN - скрыт от пользователя. Чаще всего работает поверх MPLS, VXLAN

пользовательский 
- Site-to-Site
- Remote Access (PPtP, IpSEC)

![](pictures/03.jpg)

![](pictures/04.jpg)

GRE - простой протокол (добавляется только 1 заголовок), используется чаще всего совместно с IPSec

PPtP, L2TP - устаревшие
TLS 1.3 - уже работает в ГОСТ-шифрованием

![](pictures/05.jpg)

- 1-й вариант - когда все бранчи ходят через центр, туннели p-t-p
- 2-й вариант - клиенты держат канал между собой для доступа к сервисам друг друга.

## GRE ##
Первый вид, широко распространенных протоколов, мультивендорный.

![](pictures/06.jpg)

P-t-P - значит на каждый филиал строим отдельный туннель
L3 BC/MC/UC - поддерживает, в отличии от IPSec
IPv6 - поддерживает, но надо тестировать

![](pictures/07.jpg)

Туннель нужен нам для того чтобы позволить одновременно использовать и NAT и FW в IPv4. Можно использовать TLS-шифрование, IPSec.

Пример настроек

![](pictures/08.jpg)

На рисунке показано как упаковываются данные в протокол GRE. Размер пакета увеличивается, поэтому максимальный размер пакета должен быть уменьшен и на Tunnel рекомендуется настраивать MTU

![](pictures/09.jpg)

Заголовок GRE - 24 байта.
MSS - еще на 40 байт меньше ___MSS + заголовок TCP + заголовок IP ≤ MTU___

![](pictures/10.jpg)

![](pictures/11.jpg)

![](pictures/12.jpg)

## DMVPN ##

На случай если наджо поднимать множество бранчей

![](pictures/13.jpg)

![](pictures/14.jpg)

![](pictures/15.jpg)

Можно использовать где угодно, между филиалами, терминалы, банкоматы и т.п. DMVPN - лежит в основе SDWAN. При этом решает проблемы:
- Каждый вязан с каждым (строят туннели сами при указании что споук - клиент хаба)
- Уменьшает нагрузку на центральном R
- Защита с использованием IPSec
- Можно использовать протоколы маршрутизации (BGP, EIGRP)

![](pictures/16.jpg)

DMVPN - стек технологий, в основе которой лежит GRE. Составляющие
- mGRE - споуков много, 
   - все споуки имеют туннельный адрес из туннельного диапазона.
   - При этом OSPF - не подходит для устройств больше 150
   - BGP - подойдет
   - EIGRP - подойдет
   - IS-IS - не подойдет
   - Если хотим себя обезопасить, то несколько хабов

![](pictures/17.jpg)

- NHRP - позволет устанавливать соединения между бранчами и хабом. То есть HUB по-сути хранит в себе таблицу всех бранчей
   - NHS - next hop Server ___HUB___
   - NHC - next hop Client ___SPOKE___
   - граница NHRP - в рамках DMVPN, локальные сети - поверх туннелей.

![](pictures/18.jpg)

![](pictures/19.jpg)

![](pictures/20.jpg)

- Routing (OSPF/EIGRP/BGP)  -без маршрутизации внутренние сети связаны не будут.

- IPSec (шифрование туннелей)

## Фазы DMVPN ##
3 режим аработы/фазы

![](pictures/21.jpg)

### Режим/фаза 1 ###

Весь трафик идет через HUB, включая информацию о протоколах маршрутизации, только
- для SRC - поменяется на адрес HUB

![](pictures/22.jpg)


![](pictures/23.jpg)
- На HUB (Если надо - настраиваем на каждом IF имеющем IP от ISP - свой туннель, или если есть BGP - строим туннель от loopback-а)
   - Конфиг туннеля - просто
   - ID сети (просто некий номер) 0-255, их может быть несколько, так как DMVPN тоже может быть несколько, на несколько сегментов
   - Аутентификация
   - на ___HUB___ указываем маппинг мультикаст рассылок - сопоставление белых и серых IP. 

![](pictures/24.jpg)
![](pictures/25.jpg)
- На SPOKE
   - Конфиг туннеля - просто
   - ID сети (просто некий номер) - аналогично HUB
   - Аутентификация
   - на ___SPOKE___ указываем маппинг мультикаст адрес хаба. "Этот адрес дальше разберется"
   - серый адрес ___HUB-а___
   - сопоставить белый и туннельный адреса HUB и 

Диагностика
``` sho ip nhrp ```
![](pictures/26.jpg)

Желтым выделены статусы состояния

![](pictures/27.jpg)


``` show dmvpn ```

![](pictures/28.jpg)

попробовать настроить DMVPN PHASE 1

![](pictures/29.jpg)



### Phase 2 ###

![](pictures/30.jpg)

Споук обращается к HUB за ip-адресом другого споука, и запускается и сам трафик. Но в какой-то момент времени хаб открывает секрет, кто-же является вторым споуком. Пока Споук1 - не знал ничего о Споуке 2 - трафик шел через ХАБ

![](pictures/31.jpg)

![](pictures/32.jpg)

![](pictures/33.jpg)


![](pictures/34.jpg)

Конфиг ХАБА - ничем не отличается от  фазы 1

![](pictures/35.jpg)

На SPOKE

Появляется команда tunnel mode gre multipoint

![](pictures/36.jpg)

![](pictures/37.jpg)

Преимущество

![](pictures/38.jpg)

- клиенты могут общаться между собой, напрямую (аналог full-mesh)

Недостатки
- все равно нужен HUB.
- железки Споуков могут не потянуть таблицу маршрутизации

![](pictures/39.jpg)

Механизм хранения данных о Spoke в NHRP таблице, для HUB
![](pictures/40.jpg)


Конфиг Spoke , таймер желательно держать уникальным.
![](pictures/41.jpg)

Если белого IP - нет, то на SPOKE ```ip nhrp registration no-unique```, где 10.64.0.2 - белый адрес ISP