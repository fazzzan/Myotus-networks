OTUS 202105181 (дополнено материалами INE)

___дослушать 22 23 лекции___

ВНИМАНИЕ: частые обрывы bgp сессии влекут за собой санкции, так называемы penalty и временное исключение AS из ретрансляции. Вызваны такие меры тем, что при каждом изменении анонсов AS, всем маршрутизаторам приходится пересчитывать маршруты, что на магистральных маршрутизаторах может вызывать излишнюю нагрузку и нарушать работу всей сети в целом, поэтому проще временно, на 10-20 минут, а при частых повторах подобных флапов и на несколько часов исключить одну автономную систему, чем нарушить работу сети в целом.


В большую лабу включил конфиг LinkmeUP (страница L22-BGP_LinkmeUP)

E:\Study\GIT\DarkMycal\Part1\L10\config

- Просмотр соседей
   - ```do sho ip bgp nei | in neighbor is| state ```
   - ```sho ip bgp summ```
   - ```sho bgp ipv6 summ```

- Информация о маршрутах BGP
   - ```do sho ip bgp```
   - ```do sho ipv6 bgp```

- Посмотреть таблицу до фильтров, роут мапов и так далее
   - ```show ip bgp neighbors 1.1.1.1 received-routes```

- После route-map, фильтров, префиксов и прочего:
   - ```show ip bgp neighbors 1.1.1.1 routes```

- Посмотреть до исходящих route-map, фильтров и т.п.:
   - ```sh ip bgp```

- Посмотреть после исходящих route-map, фильтров и т.п.:
   - ```show ip bgp neighbors 1.1.1.1 advertised-routes```

# BGP #

BGP работает с понятием AS. AS выдаются на организацию и поэтому в мире AS сотни тысяч.

Сам BGP поддерживает огромноое количество маршрутов, совсем недавно таких маршрутов было 512 тысяч. Почит кажды роутер магистрального провайдера имеет таблицу маршрутизации с таким количеством записей. Такая таблица маршрутизации называется ___Full View___. R нужно несколько часов со включения, чтобы подгрузить этот объем записей.

OSPF не сможет работать с таким большим объемом записей (скажем при 1000 маршрутов он уже "задымится").

BGP обладает дополнительными настройками - ___политиками___, которые овечают за то, какие маршруты могут оказаться в нашей таблице маршрутизации и какие маршруты и как мы будем отдавать соседям - ___пирам___. При этом надо понимать, что таблица маршрутизации и таблица BGP - это не одно и то же. Таблица BGP формируется на основании информации от сообщений приров, о чем поговорим позже.

Если мы купили AS, то в нашем распоряжении оказываются __провайдеро-независимые адреса___ и перед нами встает необходимость для их использования поднимать BGP-пиринг с провайдерами. При этом надо будет уметь выполнять фильтрацию маршрутов.

Также не забываем основную команду - хард-резет для BGP -процесса. После этого роутер долго будет выходить из состояния нокаута.

- ```clear ip bgp *``` 
- ```clear ip bgp <10.0.1.1>``` - разрыв пиринга с 10.0.1.1 и очистка таблицы от маршрутов, которые рассказывал 10.0.1.1 - более мягко
- ```clear ip bgp * out``` - кормим новыми маршрутами соседей


Еще 1 режим работы - ___route refresh___: не затираем старые маршруты в таблице маршрутизации, она продолжает работать, а в это время мы накачиваем от соседа новые маршруты и сохраняем их в отдельную область памяти, а затем эти новые маршруты будут либо вброшены в таблицу маршрутизации, либо на основании новой таблицы из работающей часть маршрутов удалится.

![](pictures/95.jpg)

вот как-то так для соседа, с которым надо освежить взаимоотношения для входящих маршрутов, если набрать вместо соседа *, то для всех соседей
- in - входящие маршруты
- out - исходящие маршруты

![](pictures/96.jpg)

![](pictures/01.jpg)

## ОСНОВЫ ##
Между всеми протоколами динамической много общего, но много и разного. Еще один способ деления протоколов дин. маршрутизации - по возможности работать во внешней среде:
- IGP (ISIS/OSPF/RIP/EIGRP) - interior gateway protocol - как правило предпочтительнее во внутренних сетях/доменах/областях: AD IGP меньше AD EGP и в таблицу маршрутизации по-умолчанию попадут маршруты IGP-природы.
- EGP (BGP) - exterior/border gateway protocol - работают во внешних/провайдерских сетях

![](pictures/02.jpg)

Прежде чем обмениваться маршрутами - как правило все IGP протоколы(исключение - RIP), т.е. процессы динамической маршрутизации, запущенные на R-R-R, должны установить соседство (neighbor relationship btween peers[ровня/пэры/члены палаты лордов]). Обычно это directly connected, т.е. подключюченные друг к другу физическим кабелем, участники. После установки соседских отношений начинается обмен маршрутами и пакетами ___keepalives___ (пакеты-метки а-ля "я жив, приятель")

Также работает и BGP: устанавливает "соседство", обменивается маршрутами и кипэлайвами. При этом ошибочно сравнивать IGP и BGP neqighbors/соседей:  BGP relationships/BGP peerings - немного другая процедура: тут не требуется BC/MC трафик для выяснения кто же рядом. В отличии от IGP-устройств, BGP-устройства, как правило, не являются directly connected, не могут динамически обнаруживать новых соседей и для установления соседских отношений им требуется ___четко прописать, задать/указать, с кем формировать/поднимать пиринг___. Таким образом, peer от neighbor отличается тем, что:
- neighbor-ы IGP чаще всего на одном физическом линкЕ (directly connected)
- peer-ам BGP не нужен общий физический линк, хотя они могут вступить в соседский отношения/поднять пиринг, будучи физически подключенными друг к другу.

Как и IGP:
- BGP advertise prefixes - BGP афиширует/объявляет/рекламирует префиксы/подсети.
- BGP advertise Next HOP for prefixes - BGP афиширует/рекламирует next-hop для объявляемых префиксов, так как для соседа плохо когда он не знает "через кого можно добраться до пришедшего префикса".

![](pictures/85.jpg)

Отличия от IGP:
- IP-адреса соседей/peer-ов могут и не быть в одной подсети (2-3-...-10 хопов между соседями - не проблема)
- используется TCP протокол, порт 179, UC-трафик, для взаимодействия процессов BGP у peer-ов. Еще раз подчеркну, что ___Весь___ обмен между пирами - UC:
   - первый обмен TCP-handhsake
   - обмен маршрутами
   - keeaplive

IGP OSPF использует свой собственный протокол для обмена, не TCP и не UDP. BGP - работает поверх надежного TCP.

![](pictures/86.jpg)

Еще раз про способы обмена информацией в IGP: как правило, хотя и не все, и не всегда, они обмениваются unicast маршрутами: 
- DV протоколы (RIP/EIGRP) обмениваются чисто unicast маршрутами:
   - Маршрут - это адрес/маска/next-hop
   - где next-hop - сам источник-отправитель маршрута, то есть отправитель в общих чертах говорит: отправляй информацию в сеть, которую я тебе прислал - мне, а я уже разберусь.
- LS протокол (OSPF) - поступает так не всегда, он флудит LSA-шками. При этом LSA type 1&2 - вообще не содержат маршрутов, только структурированную инфомрацию для таблицы топологий.  Маршруты в чистом виде, как это происходит у DV - содержатся только в LSA следующих типов:
   - LSA type 3 summary
   - LSA type 5 external

Теперь про BGP:
- PV протокол (BGP): Path-Vector ориентируется на путь, в отличии от LS (который ориентируется на метрику). У BGP нет понятия ___метрика___

![](pictures/83.jpg)

Технически, BGP также как и OSPF, может  отправлть unicast маршруты в чистом виде. BGP обменивается неким набором информации, которой называется ___NLRI___ - network layer reachability information. BGP очень гибок и может организовывать обмен для:
- unicast-маршрутов
- MC-маршрутов
- IPv6-маршрутов
- и т.д.

![](pictures/03.jpg)

Еще раз напомним, что BGP настраивают для взаимодействия между AS, которых сотни тысяч. По-сути BGP - монополист в этой области, в интернет. 

AS [autonomous system] - группа оборудования или целые сети, управляемые одной компанией, или даже под управлением нескольких организаций, имеющих общие концепции (наcтройки BGP и трафика исходящего из этой группы)

![](pictures/04.jpg)

![](pictures/05.jpg)

RIR - Организации отвечающие за работу сетей/AS в конкретном регионе (региональная регистратура). В каждом регионе - своя. За европейскую часть отвечают - RIPE. И с ней взаимодействовать можно как через провайдера, так и самостоятельно (в рублях - 60000/год за поддержание AS)

![](pictures/06.jpg)

IANA/RIR - выпускают отчеты об использовании адресного пространства

Анонсировать адреса можно из любой географической области мира.

Под RIR находится LIR,  и уже LIR имеет AS и адресное пространство. RIR работает с LIR.

looking glass - етсь не у всех провайдеров, для снятия статистики:
- https://www.msk-ix.ru/lookingglass/
- https://bgp.he.net/

![](pictures/07.jpg)

Таким образом, основной задачей BGP - является организация обмена информацией об AS-ах, которые он знает. При этом в BGP нет необходимости, если вы клиент с одним ISP.

![](pictures/84.jpg)

На картинке выше, по-умолчанию будет выбран верхний маршрут, по количеству проходных AS (их там меньше).


## Расширенная информация о BGP ##

![](pictures/08.jpg)

IPv4 купить уже нельзя, остается только арендовать у провайдеров. AS могут управлять несколько операторов (дочерние компании). Головная компания управляет всеми концепциями. Некоторые провайдеры успели понабрать себе AS (вместе с сетями), которые теперь могут делегировать клиентам (актуально для IPv6, для IPv4 - уже нельзя).

### iBGP/eBGP ###

![](pictures/26.jpg)

![](pictures/87.jpg)

При включении процесса BGP, мы обязательно указываем к какой AS он относится (также мы делали и при включении EIGRP). А затем, при задании пиров - дополнительно указываем к какой AS будет относится данный сосед/пир. Пиринг может устанавливаться при правильной настройке, даже если пиры в разных канальных сегментах, то есть не будучи непосредственно соединенными общим линкОм.
```
router bgp 64500
neighbor 101.0.0.1 remote-as 64501
```
R, который мы настраиваем, будет сравнивать эти AS (свою и пира), при этом делая вывод: в одной ли AS он с пиром, или - нет:
- Если ответ отрицательный, то R-R в разных AS и между ними eBGP [ external BGP]. По-умолчанию, eBGP-соседи должны быть непосредственно соединены.
- Если положительный - между пирами - internal BGP. 

Таким образом пиринг/связь может быть 2 типов:
- iBGP - внутри AS
- eBGP - между AS

![](pictures/27.jpg)

iBGP отличается от eBGP в нескольких аспектах:
- Настройки пиринга:
   - eBGP накладывает некоторые ограничения на пиров (кто может со мной общаться), чего нет в iBGP.
- Обменом префиксами. Самое первое что делает R при получении BGP updates (NLRI)  - оценивает, из какой AS он пришел:
   - BGP updates/NLRI от external пира - можно транслировать на каких угодно пиров/соседей
   - BGP updates от internal - по-умолчанию можно транслировать ___ТОЛЬКО ВНЕШНИМ___ пирам, но ни в коем случае - внутренним. Это поведение по-умолчанию и оно помогает в борьбе с петлями внутри iBGP. Хотя протокол BGP универсален и гибок и можно некоторыми настройками заставить его передавать NLRI между iBGP пирами. Речь идет о функционале:
      - route reflectors
      - confidertions
- Update modificatoins. В случае сравнения iBGP vs eBGP, существуют соглашения, согласно которым атрибуты делятся на те, которые:  
   - могут передаваться только internal пирам
   - могут передаваться только external пирам

Чтобы понять последнее отличие, вспомним о способах фильтрации/отбора лучших маршрутов с одинаковой AD в IGP протоколах:
   - RIP - hop count (чем меньше - тем лучше)
   - EIGRP - distance (чем меньше - тем лучше)
   - OSPF - cost (чем меньше - тем лучше)

Речь идет про метрику: выбирается лучшая. В BGP это совсем другая процедура: BGP update включает в себя не метрику, а громадный, просто жуткий набор информации - NLRI [network layer reachability information]. Технически эта информация называется атрибутами пути - Path atttributes. При получении NLRI с одинаковыми префиксами от двух разных пиров, BGP протокол начинает сравнивать не метрики, а наборы атрибутов. При этом атрибуты различаются в "весе": какие-то более важные, какие-то - менее. BGP перебирает их: от самого важного к самому неважному, чтобы остановиться/выбрать лучший маршрут при нахождении соответствующего лучшего атрибута какой-либо важности.

BGP атрибуты делит по следующим критериям:
- Известные/опциональные
- Обязательные/Необязательные
- Транзитивные/Нетранзитивные

При этом сочетание этих атрибутов не может быть произволным:
- ___Известные___ сочетаются с ___Обязательные/Необязательные___
- ___Опциональные___ сочетаются с ___Транзитивные/Нетранзитивные___

Например, атрибут ___next-hop___ - ___Известный & Обязательный___ - его ОБЯЗАТЕЛЬНО надо передавать всем пирам: iBGP и eBGP. Другой атрибут ___local preference___ - ___Известный & Необязательный___, его нельзя передавать eBGP пирам.

Также необходимо отметить, что AD iBGP и eBGP - разные:
- eBGP AD = 20 - он бьет другие протоколы динамичесокй маршрутизации.
- iBGP AD = 200 и подходит только как маршрут последней надежды, если никаких других маршрутов уже не останется. При этом надо понимать, что AD IGP ниже и по-умолчанию при одновременном поступлении маршрутов природы BGP и IGP, предпочтение будет отдано IGP.


На примере ниже, маршрут полученный по BGP, проигравший какому-то IGP протоколу: он не используется в таблице маршрутизации и в самом начале, перед префиксом указан статус ___r___.

![](pictures/91.jpg)

## AS ##
AS - это некий номер, который закреплен за конкретной организацией. Прогресс выдавания номеров AS - представлен ниже.

![](pictures/09.jpg)

До 2012 года выдавались AS 1 - 64495, сейчас уже выдаются  из 2-го диапазона.

Приватные номера AS ___64512 - 65534___ - немаршрутизируемые, в целом они нужны для работы внутри моей AS. Назначаю их я сам.

23456 - для работы старого оборудования, которое умеет работать только с 16-битным номерами AS. Таким номером старое оборудрование дает понять что пришедший 32-битный номер AS оно не в состоянии переварить.

![](pictures/10.jpg)

В RFC 4893 появилось понятие ___mappable ASN___, т.е. AS, которые имеют значение 0-65532 (к этим значениям спереди дописывают 16 нулей)

Виды записи ASN отличаются:
- 0 - 4294967295
- как нуль и последующее значение (разность номера AS и 65535)

![](pictures/11.jpg)

## BGP - DV протокол ##

BGP на Маршрутизаторе настраивают таким образом, что он начинает понимать: какая сеть находится в какой AS.

![](pictures/29.jpg)

Позже появляется такое понятие как путь до конечной AS называемый AS-PATH: он составляется из номеров всех проходных AS. При передаче маршрута внешнему соседу номер AS всегда добавляется в начало списка AS-path, то есть по-сути это список

![](pictures/12.jpg)

![](pictures/13.jpg)

AS-PATH может использоваться для:
- Предотвращение петель (если update придет с информацией о собственной AS) -  в AS-Path не должно быть повторяющихся номеров. Но могут быть исклчюения
   - AS-PATH prepend (повторение номера зоны AS 300,300,300,300, что позволяет создать более емкий/фейковый путь, и тем самым заставить пира думать что данный маршрут длиннее/хуже или лучше). Это необходщимо для распределения трафика, когда трафики разделяются через разные линкИ
   - Соединение физически разделенн сегментов одной AS (Соединение AS через промежуточную AS)
- Фильтрация
- Выбор минимального пути (логика RIP). В таблице маршрутов будут все пути, но в таблице маршрутизации  - лучший

![](pictures/14.jpg)

## Пиринг/Соседство/смежность (peer - ровня/пэр) ##
Еще раз напомним, что в BGP нет необходимости непосредственной физической связности роутеров. Обязательна только IP-связности. Получается, что необходимо чтобы внутри AS обязательно работал какой-то IGP протокол, тогда пиринг поднимется со всеми соседями AS.

А вот между AS по-умолчанию, без доп. настроек, необходима физическая связность.

![](pictures/88.jpg)

![](pictures/15.jpg)

![](pictures/28.jpg)

Самая распространенная ошибка при настройке BGP - забыли проверить ip-связность между пирами BGP. BGP  даже не почешется, если между пирами есть какие-то еще R, которые знать ничего не знают про сети, из ip-адресов которых идут анонсы BGP. Перед началом BGP обмена - доложен выполняется 3-way handshake с пиром:
- Syn
- Syn-Ack
- Ack

![](pictures/30.jpg)

и, на этом, первом этапе, BGP нечего делать. Никакие BGP - пакеты даже не начнут отправляться в сеть, если:
- на SRC нет маршрута до пира
- промежуточные R не знают конкретных пиров, и не могут передать им трафик. 
- существуют промежуточные ACL, которые запрещают TCP-обмен (например заперещено все кроме icmp)

Есть определенная издевка в начале работы с BGP: BGP не будет использовать default маршрут/нулевку. Таким образом, деже если между пирами и ходит пинг или работает telnet на основании нулевки, пиринг не поднимется. Таким образом, на самих пирах, так и на всех промежуточных R-R-R необходимо обеспечить маршруты в конкретные сети, или даже до конкретных пиров.

___Задание пиров___ - представлено на рисунке ниже. Данный вариант - для eBGP, но для iBGP - также требуется задать пиров, только там номера AS будут одинаковыми. 

![](pictures/29.jpg)

Кто первый начнет процесс обмена TCP - рассмотри чуть позже.

После установки TCP-сессии, произойдет установление пиринга:

![](pictures/31.jpg)

На этом этапе согласуются различные параметры, происходит обмен номерами AS, к которым принадлежат пиры. После этого начнется обмен BGP (NLRI - network layer reachability information)

![](pictures/32.jpg)

Ну и наконец, после получения NLRI начнется процесс выбора лучших путей

![](pictures/33.jpg)

В случае если у нас есть маршрут до какой-либо сети, например 9.9.9.9 от другого пира, начнется процедура сравнения соответствующих BGP Path attributes. В таблицу маршрутизации попадет тот маршрут, чей атрибут будет признан лучшим в этом процессе.

### Cостояние пиринга/смежности ###

Есть определенные условия для поднятия пиринга: необходимо чтобы "совпадали показания учатников/пиров" (___Sanity Check___):
- ___ip-адреса источника NLRI должен соответствовать заданному в описании пира___
- ___номера AS___
- ___настройки аутентификации___
- ___уникальные BGP Router-ID___
- ___одинаковая BGP версия (текущая - ver. 4)___


![](pictures/40.jpg)

### Задание ip-адреса источников ```update-source Loopback0``` ###

При начале TCP на 179 порту, BGP контроллирует от кого идет обмен, сравнивает его с тем ip-адресом, который указан в локальных настройках пира. Если трафик идет от друго-го пира, то " мама мне запрещает общаться с тобой" и Syn+Ack не будет отправлен. Настройки BGP позволяют задавать источник BGP трафика

![](pictures/34.jpg)

<details>
  <summary>Пример подмены update-source IF</summary>
![](pictures/36.jpg)

```
R1
router bgp 1 
 neighbor 1.1.1.2 remote-as 2

R2
router bgp 2 
 neighbor 1.1.1.1 remote-as 1
 neighbor 1.1.1.1 update-source Loopback0
```
Видны попытки начать TCP, но с учетом того, что R1 ждет ip-трафик от 1.1.1.1, ответа Syn+Ack - нет. Из лога видно больше: R1 даже не пытается ответить на SYN, так как BGP видит что пакет пришел с какого-то левого ip.
![](pictures/37.jpg)

С R1 также идут попытки поднять пиринг с R2, даже дело доходит до OPEN    

![](pictures/38.jpg)

но, R2 отправляет RST и пытается поднять свою TCP с адреса 22.22.22.22

![](pictures/39.jpg)

</details>

Решение по замене ip-адреса источника будет полезно при наличии 2 путей между AS. Трафик попытается пойти через оставшийся в живых IF, но если ip-адрес для пиринга в конфиге указан другой, то пиринга не будет:

![](pictures/42.jpg)

Пути устранения проблемы:
- 1 способ - указать 2 пира в AS (с двух сторон) - получим 2 TCP сессии, двойную загрузку CPU на поддержание: если маршрутов 300000, то в памяти R будет удвоенное число этих маршрутов. По большому счету затраты будут по памяти.
- 2 способ - использование loopback, как источник трафика: для eBGP - есть проблемка:
   - ```neighbor <XXXXXXXX> ebgp-multihop``` - ты не в одном физическом линке с пиром, поэтому маркируй TTL пришедшего пакета = 255 и считай корректным корректным TTL меньше 255. Если промежуточный хоп - R, то он может сломать всю схему: пиринг поднимется, но трафик не пойдет, так как промежуточный R должен уметь маршрутизировать трафик от стоящих по-бокам AS (BGP - это не туннель, а только способ доставки префиксов до AS).
   - ```neighbor <XXXXXXXX> disable-connected-check``` - ты не в одном физическом линке с пиром, поэтому маркируй TTL пришедшего пакета = 1, т.е. на расстоянии только одного хопа 

Для iBGP характерно подмена источника на какой-либо Loopback

<details>
  <summary>Решение через lo0 с подменой IF</summary>

```
router bgp 1
 bgp router-id 11.11.11.11 
 neighbor 22.22.22.22 remote-as 2
 neighbor 22.22.22.22 password P@ssw0rd
 neighbor 22.22.22.22 ebgp-multihop
 neighbor 22.22.22.22 update-source Loopback0

ip route 22.22.22.22 255.255.255.255 GigabitEthernet0/0 1.1.1.2
ip route 22.22.22.22 255.255.255.255 GigabitEthernet0/1 1.2.1.2 10

router bgp 2
 bgp router-id 22.22.22.22
 neighbor 11.11.11.11 remote-as 1
 neighbor 11.11.11.11 password P@ssw0rd
 neighbor 11.11.11.11 ebgp-multihop
 neighbor 11.11.11.11 update-source Loopback0

ip route 11.11.11.11 255.255.255.255 GigabitEthernet0/0 1.1.1.1
ip route 11.11.11.11 255.255.255.255 GigabitEthernet0/1 1.2.1.1 10
```
</details>

### номера AS ###
Во время установки пиринга, пир пришлет номер своей AS, и если он не совпадает с тем, который прописан в настройках пира BGP, то соседства не будет.

![](pictures/35.jpg)

<details>
  <summary>Пример Wrong AS</summary>
```
*May 29 16:22:32.694: %BGP-3-NOTIFICATION: received from neighbor 1.1.1.1 passive 2/2 (peer in wrong AS) 2 bytes 0002
R2#
*May 29 16:22:32.695: %BGP-5-NBR_RESET: Neighbor 1.1.1.1 passive reset (BGP Notification received)
*May 29 16:22:32.696: %BGP-5-ADJCHANGE: neighbor 1.1.1.1 passive Down BGP Notification received
*May 29 16:22:32.697: %BGP_SESSION-5-ADJCHANGE: neighbor 1.1.1.1 IPv4 Unicast topology base removed from session  BGP Notification received
```
</details>

### настройки аутентификации ### 
### уникальные BGP Router-ID ### 
### одинаковая BGP версия (текущая - ver. 4) ### 

Процесс BGP может существовать только для одной AS на R. R - не даст запустить другую AS, если уже одна создана

### Состояния BGP процесса ###

![](pictures/68.jpg)

процесс BGP-пиринга проходит через несколько состояний:
- IDLE - изначальное состояние соседства, 
   - задизаблили сам BGP
   - нет маршрута до neighbor
- CONNECT - получаем сообщение на  порту 179, но пока ничего не отправляем в ответ
- ACTIVE - начинается 3-сторонняя сессия: отправляем SYN и ждем ответа соседа. 
   - Если застыли в этой сессии - что-то пошло не так.
   - не установилась TCP-сессия с соседом
- OPENSENT** - значит что TCP-обмен завершился успешно (сошлись все необходимые параметры) и  BGP начинает обмен, отправляяя сообщение OPEN. Отправляется номер своей AS, и на получателе проверяется его совпадение с локальными настройками пира. Пока ответ от второй стороны пиринга - не получен
- OPENCONFIRM ** - сообщение OPEN пиром получено, все прошло хорошо и все параметры, включая AS - совпадает. Если AS не совпадает - назад отправляется ERRORMESSAGE/NOTIFICATIONMESSAGE, и процедура поднятия пиринга начинается с самого начала, с TCP. NOTIFICATIONMESSAGE - основное сообщение, в котором говорится почему пиринг не может быть поднят.
- ESTABLISHED - все настройки согласованы и сессия BGP работает, пиры теперь могут обмениватся, но при этом может возникнуть ситуация, когда им нечего отправлять

![](pictures/16.jpg)

Таким образом, Маршрутная карта BGP выглядит так:

![](pictures/19.jpg)

На каждом этапе возможен откат в IDLE, а в конце, когда уже пошли keepalive - наступает состояние ___ESTABLISHED___. Если от соседа keepalive нет, то разрываем соседство.

### BGP Router-ID/аутентификация ###
Задается, также как и в других протоколах маршрутизации, подкомандой
```
<bgp>
bgp router-id <XXXX>
<bgp>
```
ошибка при некорректном задании RID
```
%BGP-3-NOTIFICATION: sent to neighbor 1.1.1.2 passive 2/3 (BGP identifier wrong) 4 bytes 16161616 
```

![](pictures/41.jpg)

Если поменять router-id при работающей сессии BGP - пиринг развалится и будет устанавливаться заново. Как и в протоколах IGP, router-id автоматически берется из максимального ip любого up/up IF, включая loopback. 

RID необходим для того, чтобы определить кто должен инициировать 3-х сторонний TCP-обмен. Начинать должен тот, у кого RID - выше. 

![](pictures/43.jpg)

Не очень здорово, если одновременно начнутся 2 TCP-сессии, это называется ___peering collision___. В этом случае тот R, у кого RID меньше - останавливает свой TCP-обмен и отправляет код ___CEASE___.

![](pictures/44.jpg)

Чтобы peering collision не произошло - надо решить кто из пиров будет:
- active: не будет ждать таймаута при отвале сессии, сразу инициирует TCP
- passive: не может начинать TCP-сессию, вне зависимости от RID.

```
neighbor 12.12.12.12 transport connection-mode <passive>/<active>

do sho ip bgp nei | in port
```
тот пир, у кого local порт равен 179 - и будет passive. У кого громадное число - active/инициатор.

![](pictures/45.jpg)


Если BGP RID будут совпадать, то не пройдет аутентификация. Аутентификацию надо настраивать на обоих пирах.
```
<bgp>
neighbor <nei_ip> password <pass>
<bgp>
```

### Сообщения BGP ###
- OPEN - соглаосвание номеров AS, Hold Time, RID
- NOTIFICATION - для разрыва BGP - сессии
- UPDATE - основные сообщения, с кусками маршрутной информации BGP
- KEEPALIVE - выполняет 2 функции:
   - оповещение что сосед еще жив 
   - подтверждение на UPDATE. Если не получаем подтверждением, сбрасываем соседство
- ROUTE REFRESH - запрос маршрутов, без перезапуска BGP (маршрутизация бедет выполняться по старой ьаблице маршрутизации).

![](pictures/17.jpg)

Еще раз повторюсь:
- На первом этапе работает чисто протокол TCP, настраивая сессию для передачи BGP
- На втором этапе работает протокол BGP, происходит обмен между вручную настроенными соседями, с подтверждением keepalive

![](pictures/18.jpg)

Анонсировать надо OUTSIDE сети, а также транзитные или своей AS. Анонсируемые сети в BGP задаются например так:
```
router bgp 64504
 bgp router-id 4.4.4.4
 no bgp default ipv4-unicast

        neighbor 101.24.0.2 remote-as 64502
 neighbor 2001:0:101:24::2 remote-as 64502
        neighbor 101.34.0.3 remote-as 64503
 neighbor 2001:0:101:34::3 remote-as 64503
!
 address-family ipv4
  neighbor 101.24.0.2 activate
  neighbor 101.34.0.3 activate
 exit-address-family
!
 address-family ipv6
  neighbor 2001:0:101:24::2 activate
  neighbor 2001:0:101:34::3 activate
 exit-address-family
```

Или так, если подсети нет на роутере нигде, кроме Lo
```
interface Loopback100
    ip address 100.0.0.100 255.255.255.0
no shut

ip route 100.0.0.0 255.255.255.0 Null 0

router bgp 64504
address-family ipv4
network 100.0.0.0 mask 255.255.255.0
exit-address-family
```

Результат работы BGP можно просмотреть командами 
- ```do sho ip bgp```, ```do sho bgp ipv6``` - таблица маршрутов BGP
<details>
  <summary>таблица маршрутов BGP IPv4</summary>
BGP table version is 9, local router ID is 4.4.4.4
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, 
- Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
 *>  2.4.0.0/24       0.0.0.0                  0         32768 i
 *>  2.4.1.0/24       0.0.0.0                  0         32768 i
 *>  2.4.2.0/24       0.0.0.0                  0         32768 i
 *>  44.0.0.4/32      0.0.0.0                  0         32768 i
 *   101.12.0.0/24    101.34.0.3                             0 64503 64502 i
 *>                   101.24.0.2               0             0 64502 i
 *   101.13.0.0/24    101.24.0.2                             0 64502 64503 i
 *>                   101.34.0.3               0             0 64503 i
 *   101.24.0.0/24    101.24.0.2               0             0 64502 i
 *>                   0.0.0.0                  0         32768 i
 *   101.34.0.0/24    101.34.0.3               0             0 64503 i
 *>                   0.0.0.0                  0         32768 i
</details>

<details>
  <summary>таблица маршрутов BGP IPv6</summary>
R4: 
BGP table version is 20, local router ID is 4.4.4.4
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
 *>  2001::4/128      ::                       0         32768 i
 *   2001:0:101:12::/64
                       2001:0:101:34::3        0               64503 64502 i
 *>                    2001:0:101:24::2        0    0          64502 i
 *   2001:0:101:13::/64
                       2001:0:101:24::2        0               64502 64503 i
 *>                    2001:0:101:34::3        0    0          64503 i
 *   2001:0:101:24::/64
                       2001:0:101:24::2        0    0          64502 i
 *>                   ::                       0               32768 i
 *   2001:0:101:34::/64
                       2001:0:101:34::3        0    0          64503 i
 *>                   ::                       0         32768 i
 *>  2001:2:4::/64    ::                       0         32768 i
 *>  2001:2:4:1::/64  ::                       0         32768 i
 *>  2001:2:4:2::/64  ::                       0         32768 i
% NOTE: This command is deprecated. Please use 'show bgp ipv6 unicast'
</details>

Содержимое таблицы BGP отлчается от таблицы маршрутизации, и это нормально.

- ```do sho ip bgp summ``` - таблица соседства. Пример вывода ниже:

![](pictures/89.jpg)

![](pictures/90.jpg)

Из первой команды можно понять какие к нам прилетели анонсы и их атрибуты:
- Next hop (в BGP анонсы прилетают с соседа, даже если он напрямую не связан и находится в другой подсети, за маршрут к этой подсети отвечает поднятый OSPF)
- Local Preference  
- Weight
- Path (изнутри или снаружи нашей AS рилетел этот префикс)

Из следующего рисунка видно, что даже при наличии префикса в таблице BGP, он может не попасть в таблицу маршрутизации, так как пиринг между R-роутерами из данных AS - отсутствует и у R9 нет маршрута в 172.10.10.0/24. 

![](pictures/93.jpg)

Варианты исправления ситуации
- добавить статику на префикс 172.10.10.0 через Inside соответствующего бордер-R
- добавить анонс префикса 172.10.10.0 в OSPF на бордерах каждой AS. При этом на остальных R (не бордерах) префиксы из других AS будут с AD 200 и через next-hop соответствующего OUT IF бордера другой AS, так как процесс маршрутизации будет считать что получил эти маршруты от процесса OSPF, а не BGP.

![](pictures/94.jpg)

## Атаки на BGP ##
DoS - заставим учаcтника 1 подложным пакетом разорвать сессию с участником 2. Используется спец. софт, который должен генерить подобные пакеты и надо подобрать корректный TTL

![](pictures/46.jpg)

???Кстати, TTL = 1, если eBGP-сессия обнаружит ___С___- маршруты???

Ранее мы настраивали прием eBGP сессии с TTL>=1. Но можно обезопасить себя от этой атаки, добавив в конфиг ```ttl-security hops```. 
```
<bgp>
neighbor 12.12.12.12 ttl-security hops <1-254>
<bgp>
```
![](pictures/47.jpg)

Результатом будет отброс пакетов, которые имеют TTL < (255 - hops). Допустим мы задали hops=5 т.о. любой пакет, который приходит с TTL<250(255-5) будет дропнут, а все пакеты которые придут с TTL>=250 будут приняты.  Т.е. мы уменьшаем радиус BGP сети, тем самым закрываясь от злоумышленников. На картинке видно, что пришедший пакет будет иметь TTL 252, что меньше ожидаемого 255-1=254 и будет отброшел.

![](pictures/48.jpg)

![](pictures/49.jpg)

Надо запомнить разницу:
- ttl-security hops - применяем для безопасности
- ebgp-multihop - полное отсутствие безопасности

Вот еще 1 пример, когда надо смешать дополнительные параметры:
- ttl-sec
- disable-connected-check

![](pictures/50.jpg)

## Timers ##
Если физический CONNECTED линк  между пирами падает, BGP сразу разваливается. Но если падает какой-то промежуточный линк, то тот BGP, у которого физический линк не упадет, заметит только пропадаение keepalive и будет выжидать ___Holddown timer - 180 сек___ :

![](pictures/51.jpg)

При этом возникает проблема: весь трафик (все те десятки тысяч маршрутов), которые заворачивается на этот "полуживой" R - не будут достигать назначения. R должен ожидать истечения holddown timer, чтобы перестроить таблицу маршрутизации.

Таймеры можно допилить, но это увеличивает нагрузку на CPU да и в лабораторке это пока не нужно:

![](pictures/52.jpg)

Также может возникнуть проблема при флаппинге

## Fast Peering session deactivation ##

Чтобы избежать возьни с таймерами - используем функционал ___Fast Peering session deactivation___. Все перечисленные далее способы не задействуют CPU для обнаружения падения линкА между пирами:
- Neighbor Fall-Over
- Neighbor Fall-Over Route-Map
- Neighbor Fall-Over BFD [bidirectional forwarding detection]

![](pictures/53.jpg)

### Neighbor Fall-Over ###
формат конфига fall-over в контексте BGP:
```
router bgp 2
 neighbor 11.11.11.11 remote-as 1
 neighbor 11.11.11.11 ebgp-multihop 255
 neighbor 11.11.11.11 update-source Loopback0
 neighbor 11.11.11.11 fall-over
```
Если маршрут до пира (iBGP, eBGP) через next-hop исчезнет из таблицы маршрутизации, то пиринг со включенным fall-over развалится практически мгновенно (на виртуалке около 8 секунд), не дожидаясь истечения hold-timer (сравните 2 варианта логов на картинке ниже). 

![](pictures/56.jpg)

проверка
```
sho ip bgp neigh XX.XX.XX.XX | in state
```

___Примечание___: fall-over не отработает, если есть ___default___ маршрут: для ___fall-over___ все будет хорошо, с его точки зрения пир доступен по другому маршруту. Но мы помним: ___даже если icmp трафик доходит до пира по другому пути, то пиринг BGP может не подняться___.

Примером может служить случай, когда часть R-R-R в той же самой AS существует параллельно с маршрутами пиринга. Теоретически она способна   транслировать нужный трафик, при этом не участвуя в BGP (на изображении ниже - серые роутеры работающие на EIGRP AS 100):

![](pictures/57.jpg)

Эти серые R работают без iBGP и возможно просто имеют дефолтные маршруты до R1 и R3. Из рисунка видно, что на этих серых RRR используется адресное пространство аналогичное тому, которое используется пирами. Также, получается что RX и RY из EIGFP AS 100 будут транслировать суммарные маршруты - каждый своему R-GW. Т.о. у R1 (аналогично и для R2), в таблице маршрутов будет существовать 2 маршрута:
- один конкретный на R3(Lo0) /32, через R2 - он и будет спользоваться при поднятии пиринга R1 - R3
- второй, менее специфичный /16, через RX

Оба этих маршрута будут валидными с точки зрения ___fall-over___. Если промежуточный линк R1-R2 упадет, то ___fall-over___ - будет считать что R3 будет технически доступен через RX. ___fall-over___ всегда трекает доступность пира указанного в настройке. Ему наплевать на то, что:
- iBGP или eBGP не могут использовать дефолтные маршруты
- iBGP или eBGP не могут использовать суммарые маршруты 

Таким образом ___fall-over___ не будет моментально рвать BGP-пиринг. Сам же BGP, как было сказано ранее - не умеет использовать суммарный и default маршрут и будет ждать истечения таймера для разрыва пиринга.

Еще раз повторю, что ___fall-over___ тупо будет видеть R3 через "агрегированный"/суммарный маршрут. ___Fall-over___ поступает так: если у меня есть доступность до пира через какой-либо next-hop, то все - OK и BGP я ничего не скажу.

Выход из рассмотренной проблемы представлен ниже

### Next-hop address Tracking: ```route-map``` + ```fall-over``` ###
Технология ___next-hop address Tracking___, связывает ```route-map``` и ```fall-over```:
- создаем ACL на интересующий маршрут
- создаем ```route-map``` на ACL, тем самым трекаем наличие именно маршрута до BGP пира
- дописываем в контекст BGP нужный route-map
- перестаем волноваться о падении конкретного /32 маршрута

![](pictures/58.jpg)

Происходит следующий процесс: route-map трекает (стоит на шухере) маршрут до пира и если он пропадает, то fall-over получает пинок от route-map: "АТАС, маршрут пропал", после чего сам fall-over передает BGP сообщение что пира больше нет и надо рвать пиринг (так как пропал маршрут до пира).

![](pictures/59.jpg)

```
router bgp 1
neighbor 1.1.1.2 remote-as 1
neighbor 11.11.11.11 remote-as 1
exit

access-list 101 permit 11.11.11.11 0.0.0.0

route-map BGP-PEER permit 10
match ip address 1
exit

router bgp 1
neighbor 11.11.11.11 fall-over route-map BGP-PEER
exit
```

Но в представленной ниже ситуации (undirectly connected peers) нам это не поможет, так как физически линк между AS2-AS1, с точки зрения R2(AS2) - в полном порядке, и маршрут до пира останется на месте, и только по таймауту пиринг развалится.

![](pictures/59.jpg)

### Neighbor Fall-Over BFD [bidirectional forwarding detection] ###

Можно изучать несколько часов:
- собственный, отдельный, не-BGP keepalive механизм
- реализован на UDP & CEF (проверить что он везде включен)
- поднимает BFD-сессию между BFD-пирами 
- похожа на ```fall-over```, также определяет что BGP - пир ушел "в закат", при этом не загружая CPU самого роутера.
- ___Но___ механизм BFD не отслеживает падение маршрута до BGP-пира (в общем случае он может и не упасть). А отслеживает BFD/UDP ping, причем определяет за миллисекунды что пир исчез.
- Может использоваться не только для BGP: один и тот же BFD-пиринг может влиять и на BGP, и на EIGRP (Чуваки, АТАС, пиры отвалились).

Включается с двух сторон, с момента включения использует 2 типа пакетов:
- Control: обязателен, использовался еще в оригинальной версии BFD, загружает CPU 
   - используется для установления BFD-сессии
- Echo: опциональный, появился позже, теперь включается по-умолчанию, вместе с Control
   - проверяет forwarding path до пира
   - содержит src & dst адреса участников
   - использует негарантированный UDP, очень-очень быстрый, работает как-бы в промежутках между CONTROL.
   - может быть отключен (хотя непонятно зачем его отключать), тогда контроль линкА останется висеть на CONTROL пакете

Т.о., BFD включается в 2 этапа:
- на IF-ах обоих участников
   - CONTROL - обмен информацией о настройках, согласовывание таймеров
   - ECHO - быстро-быстро проверяет что канал живой и потеря ECHO пакетов говорит о том что канал упал.
- в протоколе маршрутизации (в нашем случае в BGP)

ECHO - пожалуй самый интересный пакет, так как:
- L2 SRC/DST - сам отправитель
- L3 SRC/DST - сам отправитель
Когда пакет прилетает соседу со включенным BFD и CEF, а в его FIB & adjacency table уже есть контакты отправителя, FIB без привлечения CPU сразу миррорит пакет обратно. На основании получения обратного пакета, отправитель делает вывод что BFD-пир живехонек. 

Конфигурация

```
<if>
bfd interval 100 min_rx 200 multiplier 3
</if>
```
- 100 - ПРЕДЛАГАЮ отправлять пакеты с такой частотой: если у получателя второе значение - скорость приема меньше, т.е. значение в абсолютной величине больше, то будем отправлять пакеты реже, на его частоте
- 200 - ПРИНИМАТЬ пакеты я могу не чаще чем 1/раз в 200 ms (не отправляй чаще, например 50 ms - я уже не обработаю): если у получателя первое значение  - скорость отправления чаще, т.е. значение в абсолютной величине меньше, то будут отправлять на моей частоте 200, а если реже, например 150, то я тоже уменьшу свою частоту отправки, увеличу периоды между отправками
- 3  - множитель согласованного времени отправления: то есть если я не получу ECHO ответа в X раз дольше, чем согласованная скорость отправки, я признаю канал упавшим
 
![](pictures/61.jpg)

Настройка:

![](pictures/62.jpg)

___дослушать 22 23 лекции___

### II-часть INE ###

![](pictures/67.jpg)

Речь пойдет о возможности BGP передавать разную информацию в своих NLRI. Технически, каждый раз, когда NLRI анонсирует префикс, делается это с атрибутами, которые называются Path-Attributes. Например, у маршрута ipv4 есть один атрибут: next-hop.

Атрибуты необходимы, чтобы при получении маршрута с одинаковой AD, они попадали в таблицу маршрутизации, только после сравнение Path-Attributes: в таблицу попадает лишь лучший Дункан Маклауд (может быть и больше, но надо дополнительно настраивать BGP).

Техническое название BGP = MP-BGP [multiprotocol BGP] - в любой момент времени может быть скомпонована дополнительная часть и "подключена" к уже имеющимся определениям. Технически это достигается компоновкой передаваемой информации в виде ___TLV___ [type link value]. 

[TLV](https://datatracker.ietf.org/doc/html/rfc7752#page-8)

![](pictures/64.jpg)

Например, при формировании пиринга, отправляется сообщение OPEN, при этом OPEN содержит несколько TLV, со своими значениями внутри каждого TLV-поля.  

Еще раз: MP-BGP - потому что внутри BGP можно положить все, что угодно (но по-умолчанию рассылаются только IPv4 префиксы):

![](pictures/65.jpg)

Если необходимо передавать NLRI с IPv6 , то возникают варианты...

### Что видит BGP при формировании пиринга ###

![](pictures/66.jpg)

Команда ```neighbor``` - необходима для статического формирования пиринга, путем задания пира противоположной стороны. При этом по-умолчанию включена работа только по IPv4. Поэтому работу BGP можно задать еще одним способом: 
- ```address-family ipv4 unicast``` задаем протокол работы BGP -  ip4/ipv6/ipv4 multicast и т.д. В BGP ```address-family``` используются для того, чтобы BGP мог передавать не только IPv4 unicast, но и информацию других протоколов. Какой протокол указан, те адреса и будут использоваться на L3 линке, иначе next-hop подставить свой ip - не получится. 
- ```neighbor 1.2.1.1 activate``` - копируем адрес пира и активируем его для работы в заданном режиме BGP
- копируем заданные сеть, которую передадим в заданном режиме BGP указанным пирам.

### Понятие семейства адресов ###
Допустим, RRR хотят сформировать пиринг и у обоих есть Connected сети IPv6, которые надо заанонсировать через имеющиеся IPv4-линкИ.

Надо создать еще одну address-family, уже для IPv6.
```
address-family ipv6
```
Между пирами возникнет UC-обмен NLRI с IPv4 и IPv6. Но... В анонсах префиксов надо указывать next-hop до анонсируемой сети, то есть указывать свой собственный IP. Поскольку линк между пирами IPv4, то и в анонсы IPv6 тоже попадет next-hop IPv4, что не будет работать. Таким образом возникает вопрос: как ___же нам поступать?
1. Формировать и поддерживать 2 сессии. В общих чертах, какую информацию мы хотим передавать в BGP, такую address-family и надо конфигурировать IF: IPv4, IPv6 и т.д. При этом получается, что для каждого протокола работы BGP будет подниматься своя TCP-сессия, внутри которой и будут анонсироваться нужные префиксы. Что в условиях реальных сетей (сотни пиров) будет приводить к удвоению перерабатываемой информации: IPv4/IPv6.
2. Формировать только 1 сессию BGP, и в анонсе передавать как NLRI IPv4, так и NLRI IPv6 для соответствующих префиксов (ну или наоборот). При этом необходимо обеспечивать корректную информацию по next-hop.

___Реализация___
1. Вариант - самый плохой: формирование раздельных сессий IPv4/IPv6. При этом если не вписать команду ```no bgp default ipv4-unicast``` - информация о всех анонсируемых сетях пойдет как в IPv4, так и в IPv6. Поэтому не забываем эту команду, которую можно перевести как: "Не использую ipv4-UC до тех пор, пока не будет явно задан пир, который использует ipv4-UC. ".

![](pictures/69.jpg)

Лабораторка есть

2. Вариант - когда TCP - сессия одна, и в контексте IPv4 передается NLRI для IPv6
   - настраиваем IPv6 на линкЕ
   - настраиваем route-map на нужный outside IF пира
   - настраиваем контекст ```address-family ipv6 unicast``` на использование правильного IPv4 пира и задаем использование route-map для формирования корректного Update для этого пира

![](pictures/72.jpg)


## Концепция работы с маршрутами в BGP ##

### INE: Originating/Injecting routes to BGP ###
BGP не инжектирует маршруты автоматически, как IGP. Для инжектирования есть 2 команды:
- ```network``` говорит: "BGP залезь в текущую локальную/IGP таблицу маршрутизации (sho ip route) и посмотри, есть ли там такие сети? Если ДА - инжектируй их в LOCAL-RIB/BGP-table". При этом BGP абсолютно фиолетово откуда там взялись эти маршруты (статик или какой-то из IGP протоколов). При этом если не задать маску, то BGP подумает что имеет дело с классовым маршрутом и если классовая маска отличается от текущей маски маршрута, то маршрут не попадет в BGP-table.

![](pictures/77.jpg)

- ```Redistribution``` - для инжектирования IGP протоколов (EIGRP/IS-IS и т.д.). Не может использоваться для редистрибьюцее дефолтного маршрута, статического маршрута. В редистрибьюции несколько ловушек:
   - рассылает частные/серые диапазоны, поэтому требует применения фильтрации [filter-out]
   - фактическая доступность статических маршрутов - ничем не отслеживаемая  
   - Маршруты, которые анонсированцы при помощи редистрибьюции - менее предпочтительны, по сравнению с теми, которое объявляются ```network``` (аналогично в eigrp/OSPF).

___Еще раз про ```network```___

По-умолчанию auto-summary отключено, а если в нашей таблице маршрутизации тысячи узких маршртутов, то можно:
- Не задавая маску, например для сети класса B выполнить команду суммаризации, в результате чего в BGP-table попадет только суммарная запись 180.180.0.0
```
<bgp>
 <address-family ipv4>
network 180.180.0.0 
auto-summary
 <address-family ipv4>
<bgp>
```
Проверка ```do sho ip bgp``` покажет какие маршруты в BGP-таблице

![](pictures/78.jpg)

Если бы пиринг был iBGP, то AD у нас было бы 200, а для eBGP = 20
![](pictures/79.jpg)

Еще 1 вариант инжектирования - с указанием ключевого слова backdoor, в этом случае если маршрут прилетает по какому-либо IGP протоколу и по eBGP, то в таблицу маршрутизации он попадет с AD и метрикой того протокола, откуда он прилетел.

Например, мы точно уверены, что ip который у нас в IGP мог прилететь откуда-то, но только случайно, в результате какой-либо ошибки

![](pictures/80.jpg)

В этом случае объявляем этот маршрут как ```backdoor``` 
```
router bgp 64501
 bgp router-id 2.2.2.1
 bgp log-neighbor-changes
 no bgp default ipv4-unicast
 neighbor 2001:1111::2 remote-as 64502
 neighbor 101.0.0.2 remote-as 64500
 neighbor 101.0.0.6 remote-as 64502
 neighbor 101.0.0.10 remote-as 64501
 !
 address-family ipv4
  network 101.0.0.0
  network 104.0.0.0 mask 255.255.240.0
  network 105.0.0.0 mask 255.255.252.0 backdoor
  neighbor 101.0.0.2 activate
  neighbor 101.0.0.6 activate
  neighbor 101.0.0.10 activate
  auto-summary
 exit-address-family
 !
 address-family ipv6
  network 2001:AAAA::/64
  neighbor 101.0.0.6 activate
  neighbor 101.0.0.6 route-map INE out
 exit-address-family
```
Он прилетел как BGP
![](pictures/81.jpg)

Но в таблице маршрутизации есть еще /32 маршрут на IGP - непонятно пока
![](pictures/82.jpg)



  

### INE:... ###
### INE:... ###
### INE:... ###
### INE:... ###

Итак, к нам прилетают маршруты, мы и сами их отправляем своим пирам. Надо фильтровать как-то этот базар. Базовые понятия - тут, более подробно - [Lecture2.25](MODULE03/Lecture25/README.MD)

- Фильтрация FullView/DEFAULT
Отправляют, как правило, на пир - все маршруты, не только DEFAULT (требуется ___prefix-list___ на пире, чтобы не забирать все остальное)

![](pictures/99.jpg)
RtB
```
router bgp 65534
 bgp router-id 192.168.0.2
 network 192.168.2.0/24
 ...
 network 192.168.12.0/24
 neighbor 192.168.0.1 remote-as 65535
 neighbor 192.168.0.1 default-originate
 neighbor 192.168.0.1 soft-reconfiguration inbound
```
RtC
```
router bgp 65533
 bgp router-id 192.168.0.6
 network 192.168.2.0/24
...
 network 192.168.10.0/24
 neighbor 192.168.0.1 remote-as 65535
 neighbor 192.168.0.1 default-originate
 neighbor 192.168.0.1 soft-reconfiguration inbound
```
Обязательно фильтруем на принимающем пире RtA, чтобы:
- RtB - предпочтительный
- RtC - вторичный
```
ip prefix-list DEFAULT-IN-PERMIT seq 5 permit 0.0.0.0/0

ip prefix-list DEFAULT-IN-DENY seq 5 deny 0.0.0.0/0
ip prefix-list DEFAULT-IN-DENY seq 10 permit 0.0.0.0/0 le 32

router bgp 65535
neighbor 192.168.0.6 prefix-list DEFAULT-IN-PERMIT in
neighbor 192.168.0.94 prefix-list DEFAULT-IN-DENY in
```
после фильтрации - ```do clear ip bgp 192.168.0.6 soft in```

- Запрет транзитных маршрутов анонсов чужих автономных систем (чтобы через нас не разлетались маршруты с нашей AS в AS-PATH) Для этого воспользуемся route-map и as-path. Настройки будем делать посредством регексп ^$ – он означает локальный AS, точнее AS у которого отсутствует AS-path.
RtA
```
configure terminal
ip as-path access-list 10 permit ^$
route-map ME-OUT
match as-path 10
router bgp 65535
neighbor 192.168.0.2 route-map ME-OUT out
neighbor 192.168.0.6 route-map ME-OUT out
```




![](pictures/20.jpg)

![](pictures/23.jpg)

Маршруты в LOC-RIB могут попасть к нам:
   - Статические/известные маршруты  (directly/static)/через проверку BGP RIB Check
   - Adj-RIB-In - входящие от соседей маршруты
LOC-RIB/FIB - BGP Database, база данных существующих маршрутов

из LOC-RIB маршруты в таблицу маршрутизации попадают:
   - через проверку 
      - next-hop (маршрут есть в текущей таблице маршрутизации)
      - validity Check
   - Выбор лучшего пути (только одного без доп. настроек). Лучший путь в 2 места:
      - таблица маршрутизации
      - таблица маршрутов для соседа (на основании которой готовится информация для соседа)

![](pictures/21.jpg)

![](pictures/24.jpg)

![](pictures/25.jpg)


Еще раз, при рассмотрении атрибутов префикса, как было сказано ранее, BGP оценивает атрибуты в соответствии с данной табличкой:

![](pictures/97.jpg)

0. ___N___ - next-hop - Смогу ли я добраться до next-hop?
   - не был запущен IGP протокол 
1. ___W___ - Weight (MAX) - Ищем маршрут с максимальным весом ()
2. ___L___ - Local Preference (MAX)  - Если информации по Weight отсутствует
3. ___L___ - Local ROUTES - локальные маршруты 
   - connected - более предпочтительные, чем прилетевшие, их WEIGHT = 32768
4. ___A___ - AS-Path (MIN длины)
5. ___O___ - Origin Code (MIN) - (IGP<EGP<incomplete). Incomplete - маршруты, которые зародились в BGP неестественныи образом = ___редистрибуция___  т.е. предпочтение будет отдано маршруту, который прилетел от IGP, по сравнению со всеми остальными.
6. ___M___ - MED (MIN) - учтитывается в самую последнюю очередь
7. ___N___ - Neighbor Type - eBGP лучше iBGP: AD 20 и 200 соответственно.
8. ___I___ - IGP предпочтительнее BGP, при условии что все остальные атрибуты не указаны
9. Старые маршруты eBGP - лучше всего
10. RouterID - лучше меньший
11. IP-адрес - лучше минимальный

Выучить этот список наизусть по аббревиатуре

![](pictures/98.jpg)